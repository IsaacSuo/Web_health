{% extends 'base.html' %}
{% load static %}
{% load math_filters %}

{% block title %}首页 - 子午养生 · 静耳时光{% endblock %}

{% block extra_css %}{% endblock %}

{% block content %}
<!-- 英雄区域 -->
<section class="hero-section">
    <div class="container">
        <div class="row align-items-center">
            <div class="col-lg-6">
                <h1 class="display-4 fw-bold mb-4">子午养生 · 静耳时光</h1>
                <p class="lead mb-4">
                    结合传统中医理论与现代数据挖掘研究成果，为您提供十二时辰养生指南和耳鸣穴位按摩推荐。
                    根据子午流注规律，在合适的时间进行针对性的养生调理。
                </p>
                <div class="d-flex gap-3">
                    {% if user.is_authenticated %}
                        <a href="{% url 'tinnitus_log_create' %}" class="btn btn-primary btn-lg">
                            <i class="fas fa-plus"></i> 记录耳鸣日记
                        </a>
                        <a href="{% url 'reminder_settings' %}" class="btn btn-outline-primary btn-lg">
                            <i class="fas fa-bell"></i> 设置提醒
                        </a>
                    {% else %}
                        <a href="{% url 'register' %}" class="btn btn-primary btn-lg">
                            <i class="fas fa-user-plus"></i> 立即注册
                        </a>
                        <a href="{% url 'tinnitus_helper' %}" class="btn btn-outline-primary btn-lg">
                            <i class="fas fa-stethoscope"></i> 了解更多
                        </a>
                    {% endif %}
                </div>
            </div>
            <div class="col-lg-6">
                {% if current_time_slot %}
                <div class="current-time-info text-center">
                    <h3 class="text-primary mb-3">
                        <i class="fas fa-clock"></i> 当前时辰：{{ current_time_slot.chinese_name }}
                    </h3>
                    <p class="mb-2"><strong>对应经络：</strong>{{ current_time_slot.meridian }}</p>
                    <p class="mb-3"><strong>对应脏腑：</strong>{{ current_time_slot.organ }}</p>
                    <p class="text-muted">{{ current_time_slot.health_tips|truncatechars:100 }}</p>
                    <a href="{% url 'time_slot_detail' current_time_slot.name %}" class="btn btn-primary mt-3">
                        查看详细信息
                    </a>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</section>

<!-- 十二时辰圆形布局 -->
<section class="py-5">
    <div class="container">
        <div class="text-center mb-5">
            <h2 class="fw-bold">十二时辰养生指南</h2>
            <p class="text-muted">点击时辰了解详细的养生建议和按摩方法</p>
        </div>
        
        <div class="d-flex justify-content-center">
            <div class="time-circle" id="timeCircle">
                <!-- 中央太极图 -->
                <div class="center-symbol" onclick="showTinnitusInfo()"></div>
                
                <!-- 脏腑标签层 -->
                <div class="organ-labels" id="organLabels">
                    {% for slot in time_slots %}
                    <div class="organ-label organ-{{ forloop.counter0 }}" id="organ-{{ slot.name }}">
                        {{ slot.organ }}
                    </div>
                    {% endfor %}
                </div>
                
                <!-- 时辰标签 -->
                {% for slot in time_slots %}
                <div class="time-slot time-slot-{{ forloop.counter0 }} {% if slot == current_time_slot %}current{% endif %}" 
                     data-slot="{{ slot.name }}"
                     data-organ="{{ slot.organ }}"
                     onclick="location.href='{% url 'time_slot_detail' slot.name %}'">
                    {{ slot.chinese_name|slice:":1" }}
                </div>
                {% endfor %}
            </div>
        </div>
    </div>
</section>

<!-- 功能特色 -->
<section class="py-5 bg-light">
    <div class="container">
        <div class="row g-4">
            <div class="col-md-4">
                <div class="card h-100 border-0 shadow-sm">
                    <div class="card-body text-center">
                        <div class="mb-3">
                            <i class="fas fa-clock fa-3x text-primary"></i>
                        </div>
                        <h5 class="card-title">时辰提醒系统</h5>
                        <p class="card-text">根据十二时辰设置个性化养生提醒，帮助您在合适的时间进行健康调理。</p>
                        <a href="{% url 'reminder_settings' %}" class="btn btn-outline-primary">设置提醒</a>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card h-100 border-0 shadow-sm">
                    <div class="card-body text-center">
                        <div class="mb-3">
                            <i class="fas fa-book-medical fa-3x text-success"></i>
                        </div>
                        <h5 class="card-title">耳鸣日记功能</h5>
                        <p class="card-text">记录耳鸣症状与按摩效果，帮助您了解症状规律，优化治疗方案。</p>
                        <a href="{% url 'tinnitus_log_create' %}" class="btn btn-outline-success">记录日记</a>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card h-100 border-0 shadow-sm">
                    <div class="card-body text-center">
                        <div class="mb-3">
                            <i class="fas fa-hand-point-up fa-3x text-warning"></i>
                        </div>
                        <h5 class="card-title">穴位按摩指导</h5>
                        <p class="card-text">提供专业的穴位按摩指导，结合时辰养生理论，提升按摩效果。</p>
                        <a href="{% url 'acupoint_list' %}" class="btn btn-outline-warning">查看穴位</a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>
{% endblock %}

{% block extra_js %}
<script>
// 鼠标悬停和触摸显示脏腑标签
document.querySelectorAll('.time-slot').forEach((slot, index) => {
    const organLabel = document.querySelector('.organ-' + index);
    
    // 鼠标悬停事件
    slot.addEventListener('mouseenter', function() {
        if (organLabel) {
            organLabel.style.opacity = '1';
        }
    });
    
    slot.addEventListener('mouseleave', function() {
        if (organLabel) {
            organLabel.style.opacity = '0';
        }
    });
    
    // 触摸设备点击事件
    slot.addEventListener('touchstart', function(e) {
        if (organLabel) {
            organLabel.style.opacity = organLabel.style.opacity === '1' ? '0' : '1';
            // 3秒后自动隐藏
            setTimeout(() => {
                organLabel.style.opacity = '0';
            }, 3000);
        }
    });
});

// 防止页面缩放 - 仅在多指触控时阻止
document.addEventListener('touchmove', function(e) {
    if (e.touches.length > 1) {
        e.preventDefault();
    }
}, { passive: false });

// 双击防缩放 - 仅阻止特定元素的双击缩放
let lastTouchEnd = 0;
document.addEventListener('touchend', function(e) {
    const now = (new Date()).getTime();
    if (now - lastTouchEnd <= 300) {
        // 只对时辰圆盘区域防止双击缩放，允许其他区域正常滚动
        if (e.target.closest('.time-circle') || e.target.closest('.time-slot')) {
            e.preventDefault();
        }
    }
    lastTouchEnd = now;
}, false);

// 中央太极图点击事件
function showTinnitusInfo() {
    {% if user.is_authenticated %}
        window.location.href = "{% url 'tinnitus_helper' %}";
    {% else %}
        if (confirm('登录后可以使用完整的耳鸣养生助手功能，是否前往登录？')) {
            window.location.href = "{% url 'login' %}";
        }
    {% endif %}
}

// 定时更新当前时辰
function updateCurrentTimeSlot() {
    fetch('{% url "current_time_slot_api" %}')
        .then(response => response.json())
        .then(data => {
            if (!data.error) {
                // 移除所有current类
                document.querySelectorAll('.time-slot').forEach(slot => {
                    slot.classList.remove('current');
                });
                
                // 为当前时辰添加current类
                const currentSlot = document.querySelector(`[data-slot="${data.name}"]`);
                if (currentSlot) {
                    currentSlot.classList.add('current');
                }
            }
        })
        .catch(error => console.error('Error:', error));
}

// 页面加载完成后执行
document.addEventListener('DOMContentLoaded', function() {
    // 为触摸设备优化点击区域（检测触摸支持）
    if ('ontouchstart' in window || navigator.maxTouchPoints > 0) {
        document.querySelectorAll('.time-slot').forEach(slot => {
            slot.style.minHeight = '44px'; // iOS推荐的最小触摸目标
            slot.style.minWidth = '44px';
        });
    }
    
    // 检查是否需要更新当前时辰
    updateCurrentTimeSlot();
});

// 每分钟更新一次当前时辰
setInterval(updateCurrentTimeSlot, 60000);

</script>
{% endblock %}